<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=91ea5fd278223521e857ad81684db507&libraries=services"></script>
    <title>Main</title>
</head>
<body>
    {% load static %}
    <div class="header">
        <div class="imgcon2"><img src="{% static 'img/veteran_logo.png' %}" alt=""></div>
        <ul class="navbar" style="list-style:none;">
            <p style="color:white;">{{ user.username }}</p>
            <li class="nav-item"><a href="{% url 'Account:mypage' %}">ğŸ‘¤ ë‚´ ì •ë³´</a></li>
            {% if user.is_host %}
            <li class="nav-item"><a href="{% url 'Game:hostGame' %}">ğŸ€ ê²½ê¸° ë“±ë¡</a></li>
            {% endif %}
        </ul>
    </div>
    <div class="wrapper">
        <div class="items">
            <!--ì§€ë„ í‘œì‹œ ë¶€ë¶„-->
            <div class="map" id='map'></div>

            <!--ê²½ê¸° ë¦¬ìŠ¤íŠ¸ ë¶€ë¶„-->
            <div class="right">
                <div class="listy">
                    <div id="line">
                        <div class="up">
                            <div style="font-size: x-large; color: rgb(47, 48, 58); text-align:center;">ê²Œì„ ë¦¬ìŠ¤íŠ¸</div>
                        </div>
                    </div>
                    <div class="details">
                        {% if message %}
                            <div class="error_block" style="display:flex; flex-direction:row; justify-content:center;">
                                <div style="color: red;">{{ message }}</div>
                            </div>
                        {% endif %}
                        <div class="games">
                            {% for game in game_list %}
                            <div class="game">
                                <div>
                                     {{ game.host }}       {{ game.numOfParticipation }}/{{ game.numOfRecruitment }}
                                </div>
                                <div>
                                    {{ game.start_datetime }}  
                                    <a class="participate" href="{% url 'Game:participate' game.id %}">ì°¸ê°€ì‹ ì²­<a>
                                </div>
                            </div>
                            {% endfor %}
                            <div class="page">
                                {% if game_list.has_previous %}
                                    <a class="page-link" style="float: left;" id="page_link" href="?page={{ game_list.previous_page_number }}">ì´ì „</a>
                                {% else %}
                                    <a class="page-link" style="float: left;" id="page_link" tabindex="-1" aria-disabled="true" href="#">ì´ì „</a>
                                {% endif %}
                                {% if game_list.has_next %}
                                    <a class="page-link" style="float: right;" id="page_link" href="?page={{ game_list.next_page_number }}">ë‹¤ìŒ</a>
                                {% else %}
                                    <a class="page-link" style="float: right;" id="page_link" tabindex="-1" aria-disabled="true" href="#">ë‹¤ìŒ</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
        </div>

    </div>


    <script>
        //ì§€ë„ ìƒì„±
        var container = document.getElementById('map');
        var option = {
            center : new kakao.maps.LatLng(37.59727,127.05884),
            level:3
        };

        var games = [];
        {% for game in game_list %}
            games.push({
                id : "{{ game.id }}",
                host : "{{ game.host }}",
                start_datetime : "{{ game.start_datetime }}",
                end_datetime : "{{ game.end_datetime }}",
                numOfRecruitment : "{{ game.numOfRecruitment }}",
                numOfParticipation : "{{ game.numOfParticipation }}",
                court_location : "{{ game.court_location }}"
            });
        {% endfor %}
        

        const map = new kakao.maps.Map(container,option);
        const court_markers=[];

        // ì£¼ì†Œ-ì¢Œí‘œ ë³€í™˜ ê°ì²´ ìƒì„±
        var geocoder = new kakao.maps.services.Geocoder();


        //í˜„ì¬ ì‚¬ìš©ì ìœ„ì¹˜ ì¢Œí‘œ ë°˜í™˜ ë©”ì†Œë“œ
        function getCurrentLocation(){
            if (navigator.geolocation){
                navigator.geolocation.getCurrentPosition(function(position){
                    var lat=position.coords.latitude,
                    lon=position.coords.longitude;
                    var locPosition=new kakao.maps.LatLng(lat,lon)
                });
            }else {
                var locPosition=new kakao.maps.LatLng(33.450701,126.590667);
            }
            return locPosition;
        }

        //ì‚¬ìš©ì ìœ„ì¹˜ ì§€ë„ì— í‘œì‹œ    
        if (navigator.geolocation){
            navigator.geolocation.getCurrentPosition(function(position){
                var lat=position.coords.latitude,
                lon=position.coords.longitude;
                
                var locPosition=new kakao.maps.LatLng(lat,lon),
                message='here';


                map.setCenter(locPosition);
                


                displayMarker(locPosition,message);
            });
            } 
            else {
                var locPosition=new kakao.maps.LatLng(33.450701,126.590667),
                message="error!"
                displayMarker(locPosition,message);
            }


        //ë§ˆì»¤ í‘œì‹œ
        function displayMarker(locPosition,message){
            var marker=new kakao.maps.Marker({
                map:map,
                position:locPosition
            });

            var iwContent = message,
            iwRemovable = true;

            var infoindow = new kakao.maps.InfoWindow({
                content : iwContent,
                removable : iwRemovable
            });
            /*infoindow.open(map, marker);*/

            map.setCenter(locPosition);
        }



       
        //ì „ë‹¬ë°›ì€ ì£¼ì†Œ ë¬¸ìì—´ì„ ì¢Œí‘œê°’ìœ¼ë¡œ ë°˜í™˜ í›„ markerìƒì„±í•˜ì—¬ court_markerì— ì¶”ê°€
        function getLatLng(address){
            geocoder.addressSearch(address,function(result,status){
                if (status == kakao.maps.services.Status.OK){
                    var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                    var marker = new kakao.maps.Marker({
                        map : map,
                        position : coords
                    });
                    
                    court_markers.push(marker);
                }
            });
        }

        for (var i = 0; i < games.length ; i++){
            getLatLng(games[i]['court_location'])
        }


        //ê²½ê¸° ì¥ì†Œ ë§ˆì»¤ í‘œì‹œ
        for (var i = 0 ; i < court_markers.length ; i++){
            court_markers[i].setMap(map);
        };

    </script>


    
</body>
</html>